#!/usr/bin/env sh
set -e

SERVER_CONFIG_PATH="/app/config.toml"

GLOBAL_CERT_FILE="${GLOBAL_CERT_FILE:-}"
GLOBAL_KEY_FILE="${GLOBAL_KEY_FILE:-}"

HTTP_SERVER_HOST="${HTTP_SERVER_HOST:-0.0.0.0}"
HTTP_SERVER_PORT="${HTTP_SERVER_PORT:-80}"
HTTP_SERVER_TIMEOUT="${HTTP_SERVER_TIMEOUT:-10}"

STORAGE_MONGO_HOST="${STORAGE_MONGO_HOST:-mongo}"
STORAGE_MONGO_PORT="${STORAGE_MONGO_PORT:-27017}"
STORAGE_MONGO_USER="${STORAGE_MONGO_USER:-customizer}"
STORAGE_MONGO_PASSWORD="${STORAGE_MONGO_PASSWORD:-secret}"
STORAGE_MONGO_DATABASE="${STORAGE_MONGO_DATABASE:-customizer}"
STORAGE_MONGO_TIMEOUT="${STORAGE_MONGO_TIMEOUT:-5}"

STORAGE_REDIS_HOST="${STORAGE_REDIS_HOST:-redis}"
STORAGE_REDIS_PORT="${STORAGE_REDIS_PORT:-6379}"
STORAGE_REDIS_DATABASE="${STORAGE_REDIS_DATABASE:-0}"
STORAGE_REDIS_PASSWORD="${STORAGE_REDIS_PASSWORD:-}"

LOG_LEVEL="${LOG_LEVEL:-error}"
LOG_FORMAT="${LOG_FORMAT:-json}"

SENTRY_URL="${SENTRY_URL:-}"
SENTRY_DEBUG="${SENTRY_DEBUG:-false}"
SENTRY_TIMEOUT="${SENTRY_TIMEOUT:-10}"

sed -i "s#{{GLOBAL_CERT_FILE}}#'${GLOBAL_CERT_FILE}'#g" "$SERVER_CONFIG_PATH"
sed -i "s#{{GLOBAL_KEY_FILE}}#'${GLOBAL_KEY_FILE}'#g" "$SERVER_CONFIG_PATH"

sed -i "s#{{HTTP_SERVER_HOST}}#'${HTTP_SERVER_HOST}'#g" "$SERVER_CONFIG_PATH"
sed -i "s#{{HTTP_SERVER_PORT}}#${HTTP_SERVER_PORT}#g" "$SERVER_CONFIG_PATH"
sed -i "s#{{HTTP_SERVER_TIMEOUT}}#${HTTP_SERVER_TIMEOUT}#g" "$SERVER_CONFIG_PATH"

sed -i "s#{{STORAGE_MONGO_HOST}}#'${STORAGE_MONGO_HOST}'#g" "$SERVER_CONFIG_PATH"
sed -i "s#{{STORAGE_MONGO_PORT}}#${STORAGE_MONGO_PORT}#g" "$SERVER_CONFIG_PATH"
sed -i "s#{{STORAGE_MONGO_DATABASE}}#'${STORAGE_MONGO_DATABASE}'#g" "$SERVER_CONFIG_PATH"
sed -i "s#{{STORAGE_MONGO_USER}}#'${STORAGE_MONGO_USER}'#g" "$SERVER_CONFIG_PATH"
sed -i "s#{{STORAGE_MONGO_PASSWORD}}#'${STORAGE_MONGO_PASSWORD}'#g" "$SERVER_CONFIG_PATH"
sed -i "s#{{STORAGE_MONGO_TIMEOUT}}#'${STORAGE_MONGO_TIMEOUT}'#g" "$SERVER_CONFIG_PATH"

sed -i "s#{{STORAGE_REDIS_HOST}}#'${STORAGE_REDIS_HOST}'#g" "$SERVER_CONFIG_PATH"
sed -i "s#{{STORAGE_REDIS_PORT}}#'${STORAGE_REDIS_PORT}'#g" "$SERVER_CONFIG_PATH"
sed -i "s#{{STORAGE_REDIS_DATABASE}}#'${STORAGE_REDIS_DATABASE}'#g" "$SERVER_CONFIG_PATH"
sed -i "s#{{STORAGE_REDIS_PASSWORD}}#'${STORAGE_REDIS_PASSWORD}'#g" "$SERVER_CONFIG_PATH"

sed -i "s#{{LOG_LEVEL}}#'${LOG_LEVEL}'#g" "$SERVER_CONFIG_PATH"
sed -i "s#{{LOG_FORMAT}}#'${LOG_FORMAT}'#g" "$SERVER_CONFIG_PATH"

sed -i "s#{{SENTRY_URL}}#'${SENTRY_URL}'#g" "$SERVER_CONFIG_PATH"
sed -i "s#{{SENTRY_DEBUG}}#${SENTRY_DEBUG}#g" "$SERVER_CONFIG_PATH"
sed -i "s#{{SENTRY_TIMEOUT}}#${SENTRY_TIMEOUT}#g" "$SERVER_CONFIG_PATH"

exec "$@"